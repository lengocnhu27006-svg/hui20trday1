<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Qu·∫£n L√Ω H·ª•i</title>

<style>
body{font-family:Arial;background:#f4f6f8;padding:20px}
h2{color:#2c3e50;margin-bottom:3px}
.sub{color:#555;margin-bottom:8px;font-style:italic}
.chuHui{color:#c0392b;font-weight:bold;margin-bottom:10px}
.info{background:#fff;padding:10px;border-radius:6px;margin-bottom:10px}
table{width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ccc;padding:8px;text-align:center}
th{background:#3498db;color:#fff}
button{padding:6px 10px;border:none;border-radius:4px;cursor:pointer}
.them{background:#27ae60;color:#fff}
.hot{background:#f39c12;color:#fff}
.xoa{background:#c0392b;color:#fff}
.ky{background:#8e44ad;color:#fff}
.song{color:#27ae60;font-weight:bold}
.chet{color:#7f8c8d;font-weight:bold}
.hotNguoi{color:#e74c3c;font-weight:bold}
.tongHot{margin-top:10px;font-size:16px;font-weight:bold}
</style>
</head>

<body>

<h2>üìã QU·∫¢N L√ù H·ª§I</h2>
<div class="sub">H·ª•i 5.000.000 ƒë / 1 th√°ng</div>
<div class="chuHui">Ch·ªß h·ª•i: Nguy·ªÖn H·∫±ng Ni</div>

<div class="info">
<b>K·ª≥:</b>
<button class="ky" onclick="doiKy(-1)">‚¨Ö</button>
<input type="number" id="ky" value="1" onchange="capNhatKy()">
<button class="ky" onclick="doiKy(1)">‚û°</button>
&nbsp;&nbsp;
<b>Ng√†y khui:</b>
<input type="date" id="ngayKhui" onchange="capNhatNgay()">
</div>

<button class="them" onclick="themNguoi()" id="btnThem">‚ûï Th√™m ng∆∞·ªùi</button>
<button class="ky" onclick="xuatPDF()">üì§ Xu·∫•t PDF g·ª≠i Zalo</button>
<button class="xoa" onclick="resetHui()" id="btnReset">‚ôª Reset d√¢y h·ª•i</button>

<table>
<thead>
<tr>
<th>T√™n</th>
<th>ƒê√£ ƒë√≥ng</th>
<th>Ti·ªÅn ƒë√≥ng</th>
<th>B·ªè thƒÉm</th>
<th>H·ªët</th>
<th>Xo√°</th>
</tr>
</thead>
<tbody id="bang"></tbody>
</table>

<div class="tongHot" id="tongHot"></div>

<script>
const TIEN_HUI = 5000000;
let laChuHui = true;

let data = {
  ky:1,
  ngay:{},
  tongHot:{},
  danhSach:[]
};

function luuDuLieu(){
  localStorage.setItem("huiData",JSON.stringify(data));
}
function taiDuLieu(){
  let d=localStorage.getItem("huiData");
  if(d) data=JSON.parse(d);
}

function capNhatKy(){
  data.ky=parseInt(ky.value)||1;
  luuDuLieu(); veBang();
}
function doiKy(s){
  data.ky+=s; if(data.ky<1) data.ky=1;
  ky.value=data.ky; luuDuLieu(); veBang();
}
function capNhatNgay(){
  data.ngay[data.ky]=ngayKhui.value; luuDuLieu();
}

function themNguoi(){
  data.danhSach.push({ten:"Ng∆∞·ªùi "+(data.danhSach.length+1),lichSu:{}});
  luuDuLieu(); veBang();
}

function daChet(n){
  for(let k in n.lichSu) if(n.lichSu[k].daHot) return true;
  return false;
}

function tickDong(i){
  let ls=data.danhSach[i].lichSu[data.ky];
  if(ls){ ls.daDong=!ls.daDong; luuDuLieu(); veBang(); }
}

function hotHui(i){
  let ky=data.ky;
  let bo=parseInt(prompt("Nh·∫≠p ti·ªÅn b·ªè thƒÉm:"));
  if(isNaN(bo)||bo<0) return;

  data.danhSach.forEach(n=>{
    if(!n.lichSu[ky])
      n.lichSu[ky]={dong:TIEN_HUI,daDong:false,daHot:false,boTham:0};
  });

  data.danhSach[i].lichSu[ky].daHot=true;
  data.danhSach[i].lichSu[ky].dong=0;
  data.danhSach[i].lichSu[ky].boTham=bo;

  let tong=0;
  data.danhSach.forEach((n,idx)=>{
    if(idx!==i){
      if(!daChet(n)) n.lichSu[ky].dong=TIEN_HUI-bo;
      else n.lichSu[ky].dong=TIEN_HUI;
      tong+=n.lichSu[ky].dong;
    }
  });

  data.tongHot[ky]=tong;
  alert("üí∞ H·ªët ƒë∆∞·ª£c "+tong.toLocaleString()+" ƒë");
  luuDuLieu(); veBang();
}

function veBang(){
  ky.value=data.ky;
  ngayKhui.value=data.ngay[data.ky]||"";
  let html="";
  data.danhSach.forEach((n,i)=>{
    let ls=n.lichSu[data.ky];
    html+=`
<tr>
<td>
 <input value="${n.ten}"
  oninput="data.danhSach[${i}].ten=this.value;luuDuLieu()"
  style="
    width:100%;
    border:none;
    text-align:center;
    background:transparent;
    font-size:20px;
    font-weight:bold;
  ">

</td>

<td>${ls?.daDong?"‚úî":""}</td>
<td>${ls?ls.dong.toLocaleString()+" ƒë":""}</td>
<td>${ls?.boTham?ls.boTham.toLocaleString()+" ƒë":""}</td>
<td>
${ls?.daHot?"üî• ƒê√É H·ªêT":daChet(n)?"‚ò† CH∆ØNG CH·∫æT":"‚úî CH∆ØNG S·ªêNG"}
${!ls?.daHot && !daChet(n)?`<br><button class="hot" onclick="hotHui(${i})">H·ªët</button>`:""}
</td>
<td><button class="xoa" onclick="data.danhSach.splice(${i},1);luuDuLieu();veBang()">‚ùå</button></td>
</tr>`;
  });
  bang.innerHTML=html;
  tongHot.innerHTML=data.tongHot[data.ky]?
  "üí∞ T·ªïng ti·ªÅn ng∆∞·ªùi h·ªët nh·∫≠n: <b>"+data.tongHot[data.ky].toLocaleString()+" ƒë</b>":"";
}

/* ===== DI·ªÑN GI·∫¢I PDF ===== */
function taoDienGiaiPDF(){
  let ky=data.ky;
  let tongChung=data.danhSach.length;
  let soChungChet=0;
  let tienBoTham=0;

  data.danhSach.forEach(n=>{
    let ls=n.lichSu[ky];
    if(daChet(n)) soChungChet++;
    if(ls?.daHot) tienBoTham=ls.boTham||0;
  });

  let chungSauHot=tongChung-1;
  let chungSong=chungSauHot-soChungChet;
  let dongChungSong=TIEN_HUI-tienBoTham;
  let tienChungSong=chungSong*dongChungSong;
  let tienChungChet=soChungChet*TIEN_HUI;
  let tienCo = 3000000; // ti·ªÅn c√≤ c·ªë ƒë·ªãnh 3 tri·ªáu
let thucNhan=tienChungSong+tienChungChet-tienCo;

  return `
<div style="margin-top:20px;padding:15px;border:2px dashed #444;font-size:18px;line-height:1.6">
<b>üìå DI·ªÑN GI·∫¢I H·ªêT H·ª§I ‚Äì K·ª≤ ${ky}</b><br><br>
${tongChung}-1=${chungSauHot}<br>
${chungSauHot}-${soChungChet}=${chungSong} ch∆∞ng s·ªëng<br><br>
${chungSong}√ó${dongChungSong.toLocaleString()}=${tienChungSong.toLocaleString()}<br>
${soChungChet}√ó${TIEN_HUI.toLocaleString()}=${tienChungChet.toLocaleString()}<br><br>
Tr·ª´ ti·ªÅn c√≤: ${tienCo.toLocaleString()}<hr>
<b>üëâ Th·ª±c nh·∫≠n: ${thucNhan.toLocaleString()} ƒë</b>
</div>`;
}

/* ===== XU·∫§T PDF ===== */
function xuatPDF(){
  let w=window.open();
  w.document.write(`
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8">
<style>
body{font-family:Arial;font-size:18px}
table th:last-child,table td:last-child,button{display:none}
th{background:#2980b9;color:#fff}
</style>
</head>
<body>
${document.body.innerHTML}
${taoDienGiaiPDF()}
</body></html>`);
  w.document.close();
  w.focus();
}

function resetHui(){
  if(!confirm("Reset to√†n b·ªô d√¢y h·ª•i?")) return;
  data={ky:1,ngay:{},tongHot:{},danhSach:[]};
  localStorage.removeItem("huiData");
  veBang();
}

taiDuLieu();
veBang();
</script>

</body>
</html>
